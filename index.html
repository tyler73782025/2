<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>å°é­”æµRPG</title>
<style>
  body {
    background: #f0f8ff;
    text-align: center;
    font-family: 'Microsoft JhengHei';
  }

  button {
    padding: 10px 20px;
    font-size: 20px;
    margin: 10px;
  }



  @keyframes blink {
    0%, 100% { opacity: 0.3; }
    50% { opacity: 1; }
  }

.card-container {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 16px;
  max-width: 800px; /* 5 å¼µå¡ç‰‡ x å¡å¯¬åº¦ + gap */
  margin: 20px auto;
}

  
  

  .flip-card {
    background-color: transparent;
    width: 160px;
    height: 220px;
    perspective: 1000px;
    flex-shrink: 0;
  }

  .flip-card-inner {
    position: relative;
    width: 100%;
    height: 100%;
    transform-style: preserve-3d;
    transition: transform 0.8s;
    cursor: pointer;
  }

  .flip-card.flipped .flip-card-inner {
    transform: rotateY(180deg);
  }

  .flip-card-front, .flip-card-back {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    box-sizing: border-box;
    overflow: hidden;
  }

.flip-card-front {
  background: linear-gradient(135deg, #d0ebff, #a5d8ff); /* æ·ºè—æ¼¸å±¤ */
  color: #1c2b33;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 30px;
  font-weight: bold;
  border: 2px solid #74c0fc;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}




  .flip-card-back {
    background-color: white;
    color: black;
    transform: rotateY(180deg);
    padding: 10px;
    font-size: 14px;
    line-height: 1.4;
    text-align: left;
  }
  
  
  
.card-loading {
  display: flex;
  flex-direction: row;       /* âœ… æ°´å¹³æ’åˆ— */
  justify-content: center;   /* âœ… ä¸»è»¸ç½®ä¸­ */
  align-items: center;       /* âœ… å‚ç›´ç½®ä¸­ */
  width: 100%;               /* âœ… å æ»¿æ•´è¡Œå¯¬åº¦æ‰èƒ½çœŸæ­£ç½®ä¸­ */
  gap: 12px;
  margin: 30px auto;
}
#loadingAreaWrapper {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
}


.card-loading {
  display: flex !important;
  flex-direction: row !important;
  justify-content: center;
  align-items: center;
  gap: 12px;
  margin: 30px auto;
  width: 100%;
  max-width: 600px;
}

.loading-card {
  width: 60px;
  height: 90px;
  background: linear-gradient(135deg, #d0ebff, #a5d8ff); /* æ·ºè—æ¼¸å±¤ */
  color: #1c2b33;
  font-size: 32px;
  font-weight: bold;
  border-radius: 8px;
  display: flex;
  justify-content: center;
  align-items: center;
  animation: spinCard 0.8s infinite ease-in-out;
  box-shadow: 0 0 6px rgba(0, 0, 0, 0.2), 0 0 12px #74c0fc;
  transform-origin: center center;
  animation: spinCard 1s infinite ease-in-out;

}

.loading-card:nth-child(2) {
  animation-delay: 0.2s;
}

.loading-card:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes spinCard {
  0% {
    transform: rotateY(0deg) scale(1);
  }
  50% {
    transform: rotateY(180deg) scale(1.08); /* âœ… æ”¾å¤§ 8% */
  }
  100% {
    transform: rotateY(360deg) scale(1);
  }
}



  .hidden {
  display: none !important;
}

/* âœ… åªæœ‰ç¿»é–‹å¡ç‰‡ï¼ˆ.flippedï¼‰æ™‚æ‰å¥—ç”¨æ•ˆæœ */
.flip-card.flipped.card-green .flip-card-back {
  box-shadow: 0 0 10px #0f0, 0 0 16px #8f8;
  border: 2px solid #0f0;
}

.flip-card.flipped.card-blue .flip-card-back {
  box-shadow: 0 0 12px #00f, 0 0 18px #0ff;
  border: 2px solid #00f;
}

.flip-card.flipped.card-purple .flip-card-back {
  box-shadow: 0 0 16px purple, 0 0 24px violet;
  border: 2px solid purple;
}

.flip-card.flipped.card-gold .flip-card-back {
  box-shadow: 0 0 20px gold, 0 0 30px gold;
  border: 2px solid gold;
}

.flip-card.flipped.card-red .flip-card-back {
  box-shadow: 0 0 24px red, 0 0 36px #ff4444;
  border: 2px solid red;
}





/*æŒ‰éˆ•*/
.draw-button {
  padding: 12px 32px;
  margin: 10px;
  font-size: 20px;
  font-weight: bold;
  border: none;
  border-radius: 12px;
  background: linear-gradient(to right, #74c0fc, #4dabf7);
  color: white;
  box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4);
  cursor: pointer;
  transition: transform 0.15s ease, box-shadow 0.3s ease;
}

.draw-button:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 14px rgba(0, 123, 255, 0.6);
}

.draw-button:active {
  transform: scale(0.98);
  box-shadow: 0 2px 6px rgba(0, 123, 255, 0.3);
}

  
  
  
  
  
  
/*èåˆå¡ç‰‡*/
  .select-checkbox {
    position: absolute;
    top: 8px;
    right: 8px;
    transform: scale(1.4);
    accent-color: #74c0fc;
    cursor: pointer;
    z-index: 2;
  }

  .flip-card-inner {
    position: relative;
  }
  
  
  
  
  
  
  
/*èƒŒåŒ…æŒ‰éˆ•*/
/* èƒŒåŒ…æ’åºæŒ‰éˆ•å€å¡Šç¾åŒ– */
#sortOptions {
  margin: 15px 0;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
}

/* æ¯é¡†æ’åºæŒ‰éˆ• */
#sortOptions button {
  font-size: 12px;
  padding: 3px 8px;
  background-color: #d0e6ff;
  border: none;
  border-radius: 6px;
  color: #003366;
  cursor: pointer;
  transition: background-color 0.2s ease;
    margin:5px;
}

#sortOptions button:hover {
  background-color: #a2c8f0;
}

#sortOptions button:active {
  background-color: #a2c8f0;
  transform: scale(0.97);
}



#filterOptions {
  margin: 15px 0;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
}

/* æ¯é¡†æ’åºæŒ‰éˆ• */
#filterOptions button {
  font-size: 12px;
  padding: 3px 8px;
  background-color: #d0e6ff;
  border: none;
  border-radius: 6px;
  color: #003366;
  cursor: pointer;
  transition: background-color 0.2s ease;
}

#filterOptions button:hover {
  background-color: #a2c8f0;
}

#filterOptions button:active {
  background-color: #a2c8f0;
  transform: scale(0.97);
}


  
  /* ç¾åŒ–æ²è»¸ï¼šé‡å°èƒŒåŒ…å€åŸŸ */
#backpackModal::-webkit-scrollbar {
  width: 10px;
}

#backpackModal::-webkit-scrollbar-track {
  background: #dceeff; /* æ²è»¸åº•è‰² */
  border-radius: 10px;
}

#backpackModal::-webkit-scrollbar-thumb {
  background-color: #74b9ff; /* æ²è»¸æ»‘å¡Š */
  border-radius: 10px;
  border: 2px solid #dceeff; /* å¤–æ¡†æ„Ÿ */
}

/* Firefox å°ˆç”¨æ²è»¸ */
#backpackModal {
  scrollbar-width: thin;
  scrollbar-color: #74b9ff #dceeff;
}



/*å°æˆ°*/
.battle-btn {
  padding: 10px 18px;
  font-size: 14px;
  border: none;
  background: linear-gradient(to right, #a0c4ff, #70a1ff);
  color: white;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.3s;
}




.battle-btn:hover {
  background: linear-gradient(to right, #70a1ff, #4d7cff);
}

.battle-target-btn {
  background: linear-gradient(to right, #ff9a9e, #fad0c4);
  color: #660000;
  font-weight: bold;
  border: 2px solid #ff8888;
}

.battle-target-btn:hover {
  background: linear-gradient(to right, #ff6b81, #fdb7b7);
  color: white;
}



#battleLog {
  font-family: "Courier New", monospace;
  font-size: 13px;
  line-height: 1.2;
}


/* æ”»æ“Šå‹•ç•«ï¼šé–ƒç´… */
@keyframes hit-flash {
  0%   { filter: brightness(1) contrast(1); }
  25%  { filter: brightness(1.2) contrast(1.5) drop-shadow(0 0 5px red); }
  50%  { filter: brightness(0.8) contrast(1); }
  75%  { filter: brightness(1.2) contrast(1.2); }
  100% { filter: brightness(1) contrast(1); }
}

.hit-effect {
  animation: hit-flash 0.4s ease;
}


@keyframes screenShake {
  0% { transform: translate(0px, 0px); }
  20% { transform: translate(-5px, 5px); }
  40% { transform: translate(5px, -5px); }
  60% { transform: translate(-5px, 0px); }
  80% { transform: translate(5px, 5px); }
  100% { transform: translate(0px, 0px); }
}

.shake {
  animation: screenShake 0.3s ease;
}

/*åŠå‹•ç•«*/
.slash-effect {
  position: absolute;
  top: 50%;
  left: 0%;
  width: 0px;
  height: 4px;
  background: linear-gradient(to right, white, red, transparent);
  transform: translateY(-50%);
  animation: slashAnim 0.4s ease-out forwards;
  z-index: 9999;
  pointer-events: none;
  opacity: 0.9;
}

@keyframes slashAnim {
  0% {
    width: 0px;
    opacity: 1;
  }
  50% {
    width: 300px;
    opacity: 1;
  }
  100% {
    width: 300px;
    opacity: 0;
  }
}

  
  
</style>

</head>
<body>

  
  

<!-- é¡¯ç¤ºç©å®¶ç›®å‰è£å‚™èˆ‡æ”»æ“ŠåŠ›-->
<div id="playerPanel" style="font-size: 14px; line-height: 1; background: #f0f8ff; padding: 12px 20px; border-radius: 12px; width: fit-content; margin: 0 auto; box-shadow: 0 0 8px rgba(0,0,0,0.05);">
  <table style="border-collapse: collapse;">
    <tr><td style="padding: 2px 8px;">ğŸ‘¤ ç©å®¶åç¨±</td><td><span id="playerName">è®€å–ä¸­...</span></td></tr>
    <tr><td style="padding: 2px 8px;">ğŸ’° é‡‘éŒ¢</td><td><span id="playerMoney">è®€å–ä¸­...</span></td></tr>
    <tr><td style="padding: 6px 0;" colspan="2"><hr style="margin: 6px 0;"></td></tr>
    <tr><td style="padding: 2px 8px;">ğŸ—¡ï¸ æ­¦å™¨</td><td><span id="equipWeapon">â€”</span></td></tr>
    <tr><td style="padding: 2px 8px;">ğŸ‘• èº«ç©¿</td><td><span id="equipBody">â€”</span></td></tr>
    <tr><td style="padding: 2px 8px;">ğŸ§¥ æŠ«æ›</td><td><span id="equipCloak">â€”</span></td></tr>
    <tr><td style="padding: 2px 8px;">ğŸ“¿ é …éŠ</td><td><span id="equipNecklace">â€”</span></td></tr>
    <tr><td style="padding: 2px 8px;">ğŸ‘¢ è…³ç©¿</td><td><span id="equipBoots">â€”</span></td></tr>
    <tr><td style="padding: 6px 0;" colspan="2"><hr style="margin: 6px 0;"></td></tr>
    <tr><td style="padding: 2px 8px;">âš”ï¸ æ”»æ“ŠåŠ›</td><td><span id="statATK">0</span></td></tr>
    <tr><td style="padding: 2px 8px;">ğŸ›¡ï¸ é˜²ç¦¦åŠ›</td><td><span id="statDEF">0</span></td></tr>
    <tr><td style="padding: 2px 8px;">â¤ï¸ HP</td><td><span id="statHP">0</span></td></tr>
    <tr><td style="padding: 2px 8px;">ğŸ’§ MP</td><td><span id="statMP">0</span></td></tr>
    <tr><td style="padding: 2px 8px;">ğŸŒ€ é€Ÿåº¦</td><td><span id="statSPD">0</span></td></tr>
    <tr><td style="padding: 2px 8px;">ğŸŒˆ å±¬æ€§</td><td><span id="statAttr">ğŸƒ0 ğŸ”¥0 ğŸ’§0 âš¡0</span></td></tr>
  </table>
</div>


  
  
<!-- ğŸ’ èƒŒåŒ…æŒ‰éˆ• -->
<button class="draw-button" onclick="startBattle()">é‡æ•µæ¸¬è©¦</button>
<button class="draw-button" onclick="openBackpack()">æŸ¥çœ‹èƒŒåŒ…</button>
<button id="singleDrawBtn" class="draw-button" onclick="drawCard('single')">å–®æŠ½</button>
<button id="tenDrawBtn" class="draw-button" onclick="drawCard('ten')">10é€£æŠ½</button>










<!-- ğŸ§³ ç„¡ç—•èƒŒåŒ…å½ˆå‡ºè¦–çª— -->
<div id="backpackModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;">
  <div style="background:#E6F4FF; margin:5% auto; width:90%; max-width:800px; border-radius:15px; overflow:hidden;">

    <!-- ä¸æ»¾å‹•çš„ä¸Šæ–¹æŒ‰éˆ•å€å¡Š -->
    <div style="padding: 16px; border-bottom: 1px solid #ccc; background: #E6F4FF;">
 
      <button class="draw-button" onclick="attemptFusion()">èåˆé¸å–å¡ç‰‡</button>
      <button class="draw-button" onclick="attemptSell()">è³£å‡ºé¸å–å¡ç‰‡</button>
      <button class="draw-button" onclick="attemptEquip()">ç©¿æˆ´é¸å–å¡ç‰‡</button>
      <button class="draw-button" onclick="closeBackpack()">é—œé–‰</button>

      
<!-- ğŸ”½ èƒŒåŒ…æ’åºåˆ— -->      
<div id="sortOptions" style="  margin: 0; display: flex; flex-wrap: wrap; gap: 2px; justify-content: center; line-height: 1;">

        <button onclick="setSort('ç¨€æœ‰åº¦')">ç¨€æœ‰åº¦</button>
        <button onclick="setSort('ç­‰ç´š')">ç­‰ç´š</button>
        <button onclick="setSort('æ”»æ“ŠåŠ›')">æ”»æ“ŠåŠ›</button>
        <button onclick="setSort('é˜²ç¦¦åŠ›')">é˜²ç¦¦åŠ›</button>
        <button onclick="setSort('HP')">HP</button>
        <button onclick="setSort('MP')">MP</button>
        <button onclick="setSort('é€Ÿåº¦')">é€Ÿåº¦</button>
		<button onclick="setRarityFilter('ç´…')">ç´…</button>
        <button onclick="setRarityFilter('é‡‘')">é‡‘</button>
        <button onclick="setRarityFilter('ç´«')">ç´«</button>
        <button onclick="setRarityFilter('è—')">è—</button>
        <button onclick="setRarityFilter('ç¶ ')">ç¶ </button>
        <button onclick="setRarityFilter('ç™½')">ç™½</button>
        <button onclick="setRarityFilter('å…¨éƒ¨')">å…¨éƒ¨</button>
</div>

      <!-- ğŸ§© èƒŒåŒ…éƒ¨ä½éæ¿¾ -->
      <div id="filterOptions" style="margin: 0px 0 0 0; display: flex; flex-wrap: wrap; gap: 4px; justify-content: center;">
        <button onclick="setFilter('å…¨éƒ¨')">å…¨éƒ¨</button>
        <button onclick="setFilter('æ­¦å™¨')">æ­¦å™¨</button>
        <button onclick="setFilter('èº«ç©¿')">èº«ç©¿</button>
        <button onclick="setFilter('æŠ«æ›')">æŠ«æ›</button>
        <button onclick="setFilter('é …éŠ')">é …éŠ</button>
        <button onclick="setFilter('è…³ç©¿')">è…³ç©¿</button>
      </div>
    </div>

    <!-- å¯æ»¾å‹•çš„å¡ç‰‡å€åŸŸ -->
    <div style="max-height: 70vh; overflow-y: auto; padding: 20px;">
      <div id="backpackCards" class="card-container"></div>
    </div>

  </div>
</div>








<!-- âœ… ä¸è¦å¤–å±¤ wrapper äº†ï¼Œç›´æ¥å¡ç‰‡å®¹å™¨è™•ç† -->
<div id="loadingArea" class="card-loading hidden">
  <div class="loading-card">â“</div>
  <div class="loading-card">â“</div>
  <div class="loading-card">â“</div>
</div>





<button class="draw-button" onclick="flipAllCards()" id="flipAllBtn" style="display: none;">å…¨éƒ¨ç¿»é–‹</button>


<div id="cardResult" class="card-container"></div>






<!-- ğŸŒ¿ è‰æ€ªæˆ°é¬¥è¦–çª— -->
<div id="battleModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:999;">
  <div style="background:#fff; margin:5% auto; padding:20px; width:95%; max-width:600px; border-radius:15px; font-size:14px; line-height:1.5;">

    
<div id="atbTimeline" style="height: 30px; background: #ddd; border-radius: 12px; overflow: hidden; margin-bottom: 10px; position: relative;">
  <!-- ç©å®¶é» -->
  <div id="playerDot" style="width: 16px; height: 16px; background: #66ccff; border-radius: 50%; position: absolute; top: 7px; left: 0px;"></div>
  <!-- æ€ªç‰©é»å°‡ç”± JS è‡ªå‹•ç”¢ç”Ÿ -->
</div>



    
<div style="position: relative; height: 120px; margin-bottom: 10px;">


<div style="position: relative; height: 140px; margin-bottom: 10px;">
  <!-- æ€ªç‰©å€‘ -->
<div id="monsterSprites" style="position: relative; height: 140px; margin-bottom: 10px;"></div>

</div>



  <!-- ç©å®¶ï¼ˆå³ä¸‹ï¼‰ -->
<div id="playerSprite" style="position: absolute; bottom: 0; right: 0; text-align: center;">
    <div style="font-size: 40px;">ğŸ§</div>
    <div style="font-weight: bold;">ç©å®¶</div>
    <div style="width: 100px; background: #ccc; border-radius: 6px; margin-top: 4px;">
      <div id="playerHpBar" style="height: 10px; background: #66ccff; width: 100%; border-radius: 6px;"></div>
    </div>
    <div style="font-size: 12px;">HPï¼š<span id="playerHP">100</span> / <span id="playerMaxHP">100</span></div>
	<div style="font-size: 12px;">MPï¼š<span id="playerMP">100</span></div>

  </div>
</div>




    <div id="battleLog" style="background:#f4f4f4; border:1px solid #ccc; border-radius:8px; padding:10px; height:120px; overflow-y:auto; margin-bottom:10px;">
      <em>æˆ°é¬¥é–‹å§‹ï¼</em>
    </div>


	<!-- ğŸ® æŒ‡ä»¤æŒ‰éˆ• -->
<div id="battleActions" style="display:flex; flex-wrap:wrap; justify-content:center; gap:10px;">

    <div id="battleActions" style="display:flex; flex-wrap:wrap; justify-content:center; gap:10px;">
      <button onclick="showAttackTargets()" class="battle-btn">æ™®é€šæ”»æ“Š</button>
      <button id="magicBtn" class="battle-btn" onclick="showMagicMenu()">æ³•è¡“æ”»æ“Š</button>
      <button disabled class="battle-btn">ä½¿ç”¨é“å…·</button>
      <button onclick="endBattle()" class="battle-btn" style="background:#aaa;">é€ƒè·‘</button>
    </div>

	<!-- ğŸ”½ é¡¯ç¤ºæ”»æ“Šç›®æ¨™æŒ‰éˆ• -->
<div id="monsterTargetOptions" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; min-height: 60px; align-items: center; width: 100%;"></div>

	
  </div>
  
</div>




<script>









  const apiBase = 'https://script.google.com/macros/s/AKfycby_dcDx5ZGZlMCDI2jMzy4Pr-fr2X6GFxs7H7a_fHK6e1CQIqMsxbs5_vZHH9zEq-gB/exec';

let currentFilter = "å…¨éƒ¨";         // åŸæœ¬çš„éƒ¨ä½ç¯©é¸ï¼ˆæ­¦å™¨ã€èº«ç©¿ç­‰ï¼‰


function setFilter(part) {
  currentFilter = part;
  loadBackpack(); // é‡æ–°è¼‰å…¥èƒŒåŒ…ä¸¦æ‡‰ç”¨ç¯©é¸
}


let currentRarityFilter = "å…¨éƒ¨";   // æ–°å¢ï¼šç¨€æœ‰åº¦ç¯©é¸
function setRarityFilter(colorName) {
  currentRarityFilter = colorName;
  loadBackpack();
}




function loadPlayer() {
    const username = "admin"; // æš«æ™‚å›ºå®šå¸³è™Ÿ

    fetch(`${apiBase}?username=${username}`)
      .then(res => res.json())
      .then(data => {
        if (data.éŠæˆ²åç¨±) {
          document.getElementById("playerName").innerText = data.éŠæˆ²åç¨±;
          document.getElementById("playerMoney").innerText = data.é‡‘éŒ¢;
        } else {
          alert("è®€å–ç©å®¶è³‡æ–™å¤±æ•—ï¼");
        }
      })
      .catch(err => {
        console.error(err);
        alert("è®€å–éŒ¯èª¤");
      });
	  
	  
  // è®€å–ç©¿æˆ´è£å‚™èƒ½åŠ›å€¼
  fetch(`${apiBase}?mode=equippedStats&username=${username}`)
    .then(res => res.json())
    .then(stat => {
      document.getElementById("statATK").innerText = stat["æ”»æ“ŠåŠ›"] || 0;
      document.getElementById("statDEF").innerText = stat["é˜²ç¦¦åŠ›"] || 0;
      document.getElementById("statHP").innerText = stat["HP"] || 0;
      document.getElementById("statMP").innerText = stat["MP"] || 0;
      document.getElementById("statSPD").innerText = stat["é€Ÿåº¦"] || 0;
      document.getElementById("statAttr").innerText =
        `ğŸƒ${stat["å±¬æ€§é¢¨"] || 0} ğŸ”¥${stat["å±¬æ€§ç«"] || 0} ğŸ’§${stat["å±¬æ€§æ°´"] || 0} âš¡${stat["å±¬æ€§é›·"] || 0}`;
    })
    .catch(err => {
      console.error("è®€å–èƒ½åŠ›å€¼å¤±æ•—", err);
    });	  


// è®€å–ç›®å‰ç©¿æˆ´çš„è£å‚™åç¨±èˆ‡ç­‰ç´š
fetch(`${apiBase}?mode=inventory&username=${username}`)
  .then(res => res.json())
  .then(inventory => {
    const uuidMap = {};
    inventory.forEach(item => {
      uuidMap[item.UUID] = `${item["åç¨±"]}${item["ç­‰ç´š"]}`;
    });

    // è®€ç©å®¶è³‡æ–™ä»¥æ‰¾å‡ºç©¿æˆ´ä¸­çš„ UUID
    fetch(`${apiBase}?username=${username}`)
      .then(res => res.json())
      .then(data => {
        document.getElementById("equipWeapon").innerText = uuidMap[data["é…æˆ´æ­¦å™¨"]] || "â€”";
        document.getElementById("equipBody").innerText = uuidMap[data["é…æˆ´èº«ç©¿"]] || "â€”";
        document.getElementById("equipCloak").innerText = uuidMap[data["é…æˆ´æŠ«æ›"]] || "â€”";
        document.getElementById("equipNecklace").innerText = uuidMap[data["é…æˆ´é …éŠ"]] || "â€”";
        document.getElementById("equipBoots").innerText = uuidMap[data["é…æˆ´è…³ç©¿"]] || "â€”";
      });
  });
	  
	  
	  
}



  // é é¢è¼‰å…¥æ™‚è‡ªå‹•å‘¼å«
  window.onload = loadPlayer;





// ğŸ´ æŠ½å¡ä¸»å‡½å¼ï¼ˆå–®æŠ½ or åé€£ï¼‰
// mode åƒæ•¸ç‚º "single" æˆ– "ten"ï¼Œåˆ†åˆ¥ä»£è¡¨å–®æŠ½æˆ–åé€£æŠ½
function drawCard(mode) {
  // ğŸ”’ ç¦ç”¨æŠ½å¡æŒ‰éˆ•ï¼Œé¿å…é€£é»
  document.getElementById("singleDrawBtn").disabled = true;
  document.getElementById("tenDrawBtn").disabled = true;

  // ğŸ§¾ æº–å‚™è¦é€å‡ºçš„è³‡æ–™ï¼ˆaction + ä½¿ç”¨è€…åç¨±ï¼‰
  const formData = new FormData();
  formData.append("action", mode);          // "single" æˆ– "ten"
  formData.append("username", "admin");     // æ¸¬è©¦å¸³è™Ÿ

  // ğŸï¸ æŠ½å¡å‹•ç•«å€ & çµæœå€
  const loading = document.getElementById("loadingArea");   // loadingå‹•ç•«
  const container = document.getElementById("cardResult");  // æŠ½å¡çµæœå®¹å™¨

  // ğŸ”„ åˆå§‹åŒ–ç•«é¢ï¼šæ¸…é™¤å¡ç‰‡ã€éš±è—ç¿»ç‰ŒæŒ‰éˆ•ã€é¡¯ç¤º loading
  document.getElementById("flipAllBtn").style.display = 'none';
  container.innerHTML = '';
  loading.classList.remove("hidden");

  // ğŸ“¡ ç™¼é€ POST è«‹æ±‚çµ¦ Google Apps Script å¾Œç«¯
  fetch(apiUrl, {
    method: "POST",
    body: formData,
  })
  .then(res => res.json()) // è§£æå›å‚³è³‡æ–™ï¼ˆåŒ…å« money, cardsï¼‰
  .then(data => {
    // ğŸ’° æ›´æ–°é‡‘éŒ¢é¡¯ç¤ºï¼ˆæ‰£æ¬¾å¾Œçš„ï¼‰
    document.getElementById("playerMoney").innerText = data.money;

    // â³ ç­‰å¾…å‹•ç•«æ’­æ”¾ä¸€æ®µæ™‚é–“å¾Œé¡¯ç¤ºå¡ç‰‡
    setTimeout(() => {
      loading.classList.add("hidden"); // éš±è— loading

      // ğŸ”„ å°æ¯å¼µå¡ç‰‡å»ºç«‹ä¸€å€‹å¯ç¿»è½‰å¡ç‰‡å…ƒä»¶
      data.cards.forEach(card => {
        const cardWrapper = document.createElement("div");

        // ğŸ¨ æ ¹æ“šç¨€æœ‰åº¦è¨­å®šå¡ç‰‡å¤–æ¡†æ¨£å¼ï¼ˆç´…ã€é‡‘ã€ç´«ã€è—ã€ç¶ ï¼‰
        let rarity = parseInt(card["ç¨€æœ‰åº¦"]);
        let rarityClass = "";
        if (rarity >= 11) rarityClass = "card-red";
        else if (rarity >= 9) rarityClass = "card-gold";
        else if (rarity >= 7) rarityClass = "card-purple";
        else if (rarity >= 5) rarityClass = "card-blue";
        else if (rarity >= 3) rarityClass = "card-green";

        cardWrapper.className = `flip-card ${rarityClass}`;

        // ğŸƒ å¡ç‰‡å‰å¾Œçš„ HTML çµæ§‹ï¼ˆç¿»é–‹å‰æ˜¯å•è™Ÿï¼Œç¿»é–‹å¾Œé¡¯ç¤ºè³‡è¨Šï¼‰
        cardWrapper.innerHTML = `
          <div class="flip-card-inner">
            <div class="flip-card-front">â“</div>
            <div class="flip-card-back">
              <strong>âœ¨ ${card["åç¨±"]}</strong><br>
              éƒ¨ä½ï¼š${card["éƒ¨ä½"]}<br>
              æ”»æ“ŠåŠ›ï¼š${card["æ”»æ“ŠåŠ›"]}<br>
              é˜²ç¦¦åŠ›ï¼š${card["é˜²ç¦¦åŠ›"]}<br>
              HPï¼š${card["HP"]}<br>
              MPï¼š${card["MP"]}<br>
              é€Ÿåº¦ï¼š${card["é€Ÿåº¦"]}<br>
              å±¬æ€§ï¼š${card["å±¬æ€§"]}
            </div>
          </div>
        `;

        // ğŸ–±ï¸ é»æ“Šå¡ç‰‡æ™‚æœƒç¿»é¢ï¼ˆåªç¿»ä¸€æ¬¡ï¼‰
        cardWrapper.onclick = () => {
          cardWrapper.classList.add('flipped');
        };

        // é¡¯ç¤ºã€Œå…¨éƒ¨ç¿»é–‹ã€æŒ‰éˆ•
        document.getElementById("flipAllBtn").style.display = 'inline-block';

        // åŠ å…¥çµæœå€
        container.appendChild(cardWrapper);
      });

      // âœ… æŠ½å¡å®Œç•¢å¾Œæ¢å¾©æŒ‰éˆ•
      document.getElementById("singleDrawBtn").disabled = false;
      document.getElementById("tenDrawBtn").disabled = false;
    }, 1500); // å‹•ç•«å»¶é²æ™‚é–“
  })
  .catch(err => {
    // âŒ ä¾‹å¤–éŒ¯èª¤è™•ç†
    loading.style.display = 'none';
    container.innerHTML = "âŒ éŒ¯èª¤ï¼šæŠ½å¡å¤±æ•—";
    console.error(err);

    // âœ… å³ä½¿å¤±æ•—ä¹Ÿæ¢å¾©æŒ‰éˆ•
    document.getElementById("singleDrawBtn").disabled = false;
    document.getElementById("tenDrawBtn").disabled = false;
  });
}

	
	
	
//ä¸€éµç¿»é–‹
function flipAllCards() {
  const cards = document.querySelectorAll('.flip-card');
  cards.forEach(card => {
    card.classList.add('flipped');
  });
}












const apiUrl = 'https://script.google.com/macros/s/AKfycby_dcDx5ZGZlMCDI2jMzy4Pr-fr2X6GFxs7H7a_fHK6e1CQIqMsxbs5_vZHH9zEq-gB/exec';

let currentSortField = 'ç¨€æœ‰åº¦'; // é è¨­æ’åºæ¬„ä½
let sortAscending = false;       // é è¨­ç‚ºé™å†ªæ’åºï¼ˆç”±å¤§åˆ°å°ï¼‰

// ğŸ”€ èƒŒåŒ…æ’åºåŠŸèƒ½å‡½å¼
// åƒæ•¸ field ç‚ºæ’åºæ¬„ä½åç¨±ï¼ˆä¾‹å¦‚ï¼šæ”»æ“ŠåŠ›ã€ç­‰ç´šã€ç¨€æœ‰åº¦ï¼‰
function setSort(field) {
  // å¦‚æœç›®å‰çš„æ’åºæ¬„ä½å°±æ˜¯é€™å€‹æ¬„ä½ï¼Œå‰‡æ”¹è®Šæ’åºæ–¹å‘ï¼ˆå‡å†ª â‡„ é™å†ªï¼‰
  if (currentSortField === field) {
    sortAscending = !sortAscending;
  } else {
    // å¦å‰‡å°±è¨­å®šæ–°çš„æ’åºæ¬„ä½ï¼Œé è¨­ç‚ºé™å†ªï¼ˆç”±å¤§åˆ°å°ï¼‰
    currentSortField = field;
    sortAscending = false;
  }

  // ğŸ§³ é‡æ–°è¼‰å…¥èƒŒåŒ…ä¸¦å¥—ç”¨æ–°çš„æ’åºæ¢ä»¶
  loadBackpack();
}


// ğŸ’ é–‹å•ŸèƒŒåŒ…è¦–çª—ï¼ˆé¡¯ç¤ºç„¡ç—•èƒŒåŒ…å½ˆå‡ºå€å¡Šï¼‰
function openBackpack() {
  // é¡¯ç¤ºèƒŒåŒ…å½ˆå‡ºè¦–çª—
  document.getElementById("backpackModal").style.display = "block";

  // è¼‰å…¥ç©å®¶çš„èƒŒåŒ…è³‡æ–™ï¼ˆæœƒè‡ªå‹•å¥—ç”¨æ’åºèˆ‡ç¯©é¸æ¢ä»¶ï¼‰
  loadBackpack();
}

// ğŸ’ é—œé–‰èƒŒåŒ…è¦–çª—ï¼ˆéš±è—ç„¡ç—•èƒŒåŒ…å½ˆå‡ºå€å¡Šï¼‰
function closeBackpack() {
  // éš±è—èƒŒåŒ…è¦–çª—
  document.getElementById("backpackModal").style.display = "none";
}


function loadBackpack() {
  const username = "admin"; // æš«æ™‚å›ºå®šå¸³è™Ÿ
  const url = `${apiUrl}?mode=inventory&username=${username}`;

  fetch(url)
    .then(res => res.json())
    .then(data => {
      data.sort((a, b) => {
        const valA = parseInt(a[currentSortField]) || 0;
        const valB = parseInt(b[currentSortField]) || 0;
        return sortAscending ? valA - valB : valB - valA;
      });

      const container = document.getElementById("backpackCards");
      container.innerHTML = '';

data.forEach(card => {
  // âœ… ç¯©é¸éƒ¨ä½
  const matchSlot = currentFilter === "å…¨éƒ¨" || card["éƒ¨ä½"] === currentFilter;

  // âœ… ç¯©é¸ç¨€æœ‰åº¦é¡è‰²
  const rarity = parseInt(card["ç¨€æœ‰åº¦"]);
  let matchRarity = true;
  switch (currentRarityFilter) {
    case "ç´…": matchRarity = rarity >= 11; break;
    case "é‡‘": matchRarity = rarity >= 9 && rarity < 11; break;
    case "ç´«": matchRarity = rarity >= 7 && rarity < 9; break;
    case "è—": matchRarity = rarity >= 5 && rarity < 7; break;
    case "ç¶ ": matchRarity = rarity >= 3 && rarity < 5; break;
    case "ç™½": matchRarity = rarity < 3; break;
  }

  if (matchSlot && matchRarity) {
    const cardWrapper = createCardElement(card);
    container.appendChild(cardWrapper);
  }
});




      const buttons = document.querySelectorAll("#sortOptions button");
buttons.forEach(btn => {
  btn.style.backgroundColor = btn.innerText === currentSortField ? "#a2c8f0" : "#d0e6ff";
});

    })
    .catch(err => {
      console.error("è®€å–èƒŒåŒ…å¤±æ•—ï¼š", err);
      alert("èƒŒåŒ…è®€å–å¤±æ•—ï¼");
    });
}

</script>
 <script>
 //èåˆå¡ç‰‡
  let selectedFusionCards = [];

  function toggleFusionSelection(uuid, checkbox) {
    if (checkbox.checked) {
      selectedFusionCards.push(uuid);
    } else {
      selectedFusionCards = selectedFusionCards.filter(id => id !== uuid);
    }
    console.log("ç›®å‰é¸å–çš„å¡ç‰‡ UUIDï¼š", selectedFusionCards);
  }



function formatAttributes(card) {
  const parts = [];
  const attrs = ["å±¬æ€§é¢¨", "å±¬æ€§ç«", "å±¬æ€§æ°´", "å±¬æ€§é›·"];
  const names = { "å±¬æ€§é¢¨": "é¢¨", "å±¬æ€§ç«": "ç«", "å±¬æ€§æ°´": "æ°´", "å±¬æ€§é›·": "é›·" };

  attrs.forEach(attr => {
    const val = parseInt(card[attr]);
    if (val > 0) {
      parts.push(`${names[attr]}${val > 1 ? val : ''}`);
    }
  });

  return parts.join(" ");
}
/*
function formatAttributesWithColor(card) {
  const result = [];
  const attrs = [
    { key: "å±¬æ€§ç«", label: "ç«", emoji: "ğŸ”¥", color: "#f66" },
    { key: "å±¬æ€§æ°´", label: "æ°´", emoji: "ğŸ’§", color: "#69f" },
    { key: "å±¬æ€§é¢¨", label: "é¢¨", emoji: "ğŸƒ", color: "#3c6" },
    { key: "å±¬æ€§é›·", label: "é›·", emoji: "âš¡", color: "#fc0" }
  ];

  attrs.forEach(attr => {
    const count = parseInt(card[attr.key]);
    if (count > 0) {
      const label = `${attr.emoji}<span style="color:${attr.color}; font-weight:bold;">${attr.label}${count > 1 ? count : ''}</span>`;
      result.push(label);
    }
  });

  return result.join(" ");
}


*/
function formatAttributesWithColor(card) {
  const result = [];
  const attrs = [
    { key: "å±¬æ€§ç«", emoji: "ğŸ”¥", color: "#f66" },
    { key: "å±¬æ€§æ°´", emoji: "ğŸ’§", color: "#69f" },
    { key: "å±¬æ€§é¢¨", emoji: "ğŸƒ", color: "#3c6" },
    { key: "å±¬æ€§é›·", emoji: "âš¡", color: "#fc0" }
  ];

  attrs.forEach(attr => {
    const count = parseInt(card[attr.key]);
    if (count > 0) {
      const label = `<span style="color:${attr.color}; font-weight:bold; font-size:12px; margin-right:4px;">${attr.emoji}${count > 1 ? count : ''}</span>`;
      result.push(label);
    }
  });

  return result.join("");
}






function createCardElement(card) {
  const cardWrapper = document.createElement("div");

  let rarity = parseInt(card["ç¨€æœ‰åº¦"]);
  let rarityClass = "";
  if (rarity >= 11) rarityClass = "card-red";
  else if (rarity >= 9) rarityClass = "card-gold";
  else if (rarity >= 7) rarityClass = "card-purple";
  else if (rarity >= 5) rarityClass = "card-blue";
  else if (rarity >= 3) rarityClass = "card-green";

  cardWrapper.className = `flip-card ${rarityClass} flipped`;

  const checkbox = document.createElement("input");
  checkbox.type = "checkbox";
  checkbox.className = "select-checkbox";
  checkbox.onclick = (e) => {
    e.stopPropagation();
    toggleFusionSelection(card["UUID"], checkbox);
  };

    cardWrapper.innerHTML = `
      <div class="flip-card-inner flipped">
        <div class="flip-card-front">â“</div>
        <div class="flip-card-back">
          <strong>âœ¨ ${card["åç¨±"]}</strong><br>
          éƒ¨ä½ï¼š${card["éƒ¨ä½"]}<br>
          æ”»æ“ŠåŠ›ï¼š${card["æ”»æ“ŠåŠ›"]}<br>
          é˜²ç¦¦åŠ›ï¼š${card["é˜²ç¦¦åŠ›"]}<br>
          HPï¼š${card["HP"]}<br>
          MPï¼š${card["MP"]}<br>
          é€Ÿåº¦ï¼š${card["é€Ÿåº¦"]}<br>
          ç­‰ç´šï¼š${card["ç­‰ç´š"]}<br>
å±¬æ€§ï¼š<br>${formatAttributesWithColor(card)}

        </div>
      </div>`;

  cardWrapper.querySelector(".flip-card-inner").appendChild(checkbox);

  return cardWrapper;
}

  
  
  
  
  
  
  function attemptFusion() {
  if (selectedFusionCards.length !== 3) {
    alert("è«‹é¸æ“‡ä¸‰å¼µå¡ç‰‡é€²è¡Œèåˆï¼");
    return;
  }

  // å‘èƒŒåŒ…è³‡æ–™æŸ¥è©¢é€™äº›å¡ç‰‡çš„è©³ç´°å…§å®¹
  const username = "admin";
  fetch(`${apiUrl}?mode=inventory&username=${username}`)
    .then(res => res.json())
    .then(data => {
      const selectedCards = data.filter(card => selectedFusionCards.includes(card["UUID"]));

      if (selectedCards.length !== 3) {
        alert("ç„¡æ³•è®€å–é¸å–çš„å¡ç‰‡è³‡æ–™");
        return;
      }

      const [name, level] = [selectedCards[0]["åç¨±"], selectedCards[0]["ç­‰ç´š"]];
      const allSameName = selectedCards.every(c => c["åç¨±"] === name);
      const allSameLevel = selectedCards.every(c => c["ç­‰ç´š"] === level);
      const levelInt = parseInt(level);

      if (!allSameName || !allSameLevel) {
        alert("èåˆå¤±æ•—ï¼šå¿…é ˆæ˜¯ç›¸åŒåç¨±èˆ‡ç­‰ç´šçš„å¡ç‰‡ï¼");
        return;
      }

      if (levelInt >= 10) {
        alert("å·²é”æœ€é«˜ç­‰ç´šï¼Œç„¡æ³•èåˆï¼");
        return;
      }

      // å‚³é€åˆ°å¾Œç«¯é€²è¡Œèåˆ
      const formData = new FormData();
      formData.append("action", "fuse");
      formData.append("username", username);
      formData.append("uuids", JSON.stringify(selectedFusionCards));


      fetch(apiUrl, {
        method: "POST",
        body: formData
      })
        .then(res => res.json())
        .then(result => {
          if (result.success) {
            alert("èåˆæˆåŠŸï¼");
            selectedFusionCards = [];
            loadBackpack(); // é‡æ–°è®€å–èƒŒåŒ…
          } else {
            alert("èåˆå¤±æ•—ï¼š" + (result.message || "æœªçŸ¥éŒ¯èª¤"));
          }
        })
        .catch(err => {
          console.error(err);
          alert("èåˆè«‹æ±‚å¤±æ•—ï¼");
        });
    });
}


//è³£å¡ç‰‡
function attemptSell() {
  if (selectedFusionCards.length === 0) {
    alert("è«‹å…ˆé¸æ“‡è¦è³£å‡ºçš„å¡ç‰‡ï¼");
    return;
  }

  const confirmed = confirm("ç¢ºå®šè¦è³£å‡ºé¸å–çš„å¡ç‰‡å—ï¼Ÿ");
  if (!confirmed) return;

  const formData = new FormData();
  formData.append("action", "sell");
  formData.append("username", "admin");
  formData.append("uuids", JSON.stringify(selectedFusionCards));

  fetch(apiUrl, {
    method: "POST",
    body: formData
  })
    .then(res => res.json())
    .then(result => {
      if (result.success) {
        alert(`æˆåŠŸè³£å‡ºå¡ç‰‡ï¼ç²å¾—é‡‘é¡ï¼š${result.earned}`);
        selectedFusionCards = [];
        loadPlayer();  // æ›´æ–°é‡‘éŒ¢é¡¯ç¤º
        loadBackpack(); // é‡æ–°è¼‰å…¥èƒŒåŒ…
      } else {
        alert("è³£å‡ºå¤±æ•—ï¼š" + (result.message || "æœªçŸ¥éŒ¯èª¤"));
      }
    })
    .catch(err => {
      console.error(err);
      alert("è«‹æ±‚å¤±æ•—ï¼");
    });
}

function equipItem(uuid, slot) {
  const username = "admin";

  const formData = new FormData();
  formData.append("action", "equip");
  formData.append("username", username);
  formData.append("uuid", uuid);
  formData.append("slot", slot); // ä¾‹å¦‚ã€Œé…æˆ´æ­¦å™¨ã€

  fetch(apiUrl, {
    method: "POST",
    body: formData
  })
    .then(res => res.json())
    .then(result => {
      if (result.success) {
        alert("ç©¿æˆ´æˆåŠŸï¼");
        loadPlayer();  // é‡æ–°é¡¯ç¤ºèƒ½åŠ›å€¼
      } else {
        alert("ç©¿æˆ´å¤±æ•—ï¼š" + (result.message || "æœªçŸ¥éŒ¯èª¤"));
      }
    })
    .catch(err => {
      console.error(err);
      alert("ç©¿æˆ´è«‹æ±‚å¤±æ•—ï¼");
    });
}


function attemptEquip() {
  if (selectedFusionCards.length !== 1) {
    alert("è«‹é¸æ“‡ä¸€å¼µå¡ç‰‡é€²è¡Œç©¿æˆ´ï¼");
    return;
  }

  const username = "admin"; // æš«æ™‚å›ºå®š
  const uuid = selectedFusionCards[0];

  // å»èƒŒåŒ…æŸ¥é€™å¼µå¡çš„éƒ¨ä½
  fetch(`${apiUrl}?mode=inventory&username=${username}`)
    .then(res => res.json())
    .then(data => {
      const card = data.find(c => c.UUID === uuid);
      if (!card) {
        alert("æ‰¾ä¸åˆ°é€™å¼µå¡ç‰‡");
        return;
      }

      const slot = `é…æˆ´${card["éƒ¨ä½"]}`; // e.g. é…æˆ´æ­¦å™¨
      const formData = new FormData();
      formData.append("action", "equip");
      formData.append("username", username);
      formData.append("uuid", uuid);
      formData.append("slot", slot);

      return fetch(apiUrl, { method: "POST", body: formData });
    })
    .then(res => res.json())
    .then(result => {
      if (result.success) {
        alert("ç©¿æˆ´æˆåŠŸï¼");
        selectedFusionCards = [];
        loadPlayer();
        loadBackpack();
      } else {
        alert("ç©¿æˆ´å¤±æ•—ï¼š" + (result.message || "æœªçŸ¥éŒ¯èª¤"));
      }
    })
    .catch(err => {
      console.error(err);
      alert("ç©¿æˆ´è«‹æ±‚å¤±æ•—ï¼");
    });
}







// === æˆ°é¬¥è®Šæ•¸ï¼ˆåªä¿ç•™é€™ä¸€çµ„ï¼‰===
let player = {};
let battleEnded = false;

let monsters = [];
let playerDotProgress = 0;
let monsterDotProgress = [0, 0];
let timelineLoop = null;
const TIMELINE_MAX = 100;
let isPlayerReady = false;
let timelinePaused = false;







let waitingForPlayer = false; // ç©å®¶æ˜¯å¦æ­£åœ¨ç­‰å¾…é¸æ“‡å‹•ä½œ




const magicSkills = [
  {
    name: "åŠä¸€",
    basePower: 100,
    attr: { ç«: 0, æ°´: 0, é¢¨: 0, é›·: 0 },
    mpCost: 10,
    target: "single",
    multiplier: 1.5,
    effect: "none",
    learnLevel: 2
  },
  {
    name: "åŠäºŒ",
    basePower: 150,
    attr: { ç«: 1, æ°´: 0, é¢¨: 0, é›·: 0 },
    mpCost: 15,
    target: "all",
    multiplier: 2.0,
    effect: "none",
    learnLevel: 3
  }
];



function showMagicMenu() {
  const container = document.getElementById("monsterTargetOptions");
  container.innerHTML = "";

  magicSkills.forEach((skill, index) => {
    const btn = document.createElement("button");
    btn.className = "battle-btn";
    btn.innerText = `${skill.name}ï¼ˆæ¶ˆè€— ${skill.mpCost} MPï¼‰`;
    btn.onclick = () => {
      if (player.mp < skill.mpCost) {
        alert("MP ä¸è¶³ï¼");
        return;
      }
      if (skill.target === "single") {
        showMagicTargets(index); // é¸æ“‡ç›®æ¨™
      } else {
        castMagic(index, null); // ç›´æ¥å…¨é«”æ–½æ³•
      }
    };
    container.appendChild(btn);
  });
}

function castMagic(skillIndex, targetIndex) {
  const skill = magicSkills[skillIndex];
  player.mp -= skill.mpCost;
  document.getElementById("statMP").innerText = player.mp;
document.getElementById("playerMP").innerText = player.mp; // âœ… é€™æ˜¯æˆ°é¬¥ç•«é¢
  if (skill.target === "all") {
    monsters.forEach((m, i) => {
      if (m.hp > 0) applyMagicDamage(skill, i);
    });
  } else {
    applyMagicDamage(skill, targetIndex);
  }

  playerDotProgress = 0;
  isPlayerReady = false;
  timelinePaused = false;
  hideBattleActions();
}


function applyMagicDamage(skill, targetIndex) {
  const target = monsters[targetIndex];
  const attackerAttr = player.attr;
  const defenderAttr = target.attr;

  let attackerFactor =
    (1 + 0.1 * attackerAttr.ç«) *
    (1 + 0.1 * attackerAttr.æ°´) *
    (1 + 0.1 * attackerAttr.é¢¨) *
    (1 + 0.1 * attackerAttr.é›·);

  let skillFactor =
    (1 + 0.1 * (skill.attr.ç« || 0)) *
    (1 + 0.1 * (skill.attr.æ°´ || 0)) *
    (1 + 0.1 * (skill.attr.é¢¨ || 0)) *
    (1 + 0.1 * (skill.attr.é›· || 0));

  const defenderFactor =
    (1 + 0.1 * defenderAttr.ç«) *
    (1 + 0.1 * defenderAttr.æ°´) *
    (1 + 0.1 * defenderAttr.é¢¨) *
    (1 + 0.1 * defenderAttr.é›·);

  let rawDmg = ((player.atk * attackerFactor) + (skill.basePower * skillFactor));
  rawDmg *= skill.multiplier;
  rawDmg /= (1 + (target.def * defenderFactor / 3));
  rawDmg *= (0.8 + Math.random() * 0.4);

  const dmg = Math.round(rawDmg);
  target.hp = Math.max(0, target.hp - dmg);

  logMessage(`ğŸŒ€ ${player.name} å° ${target.name} æ–½å±• ${skill.name}ï¼Œé€ æˆ ${dmg} å‚·å®³ï¼`, "player");

  // æ›´æ–°è¡€é‡ UI
  document.getElementById(`monsterHP${targetIndex}`).innerText = target.hp;
  document.getElementById(`monsterHpBar${targetIndex}`).style.width = `${(target.hp / target.maxHp) * 100}%`;

  // ğŸŒ€ æ’­æ”¾ç‰¹æ•ˆå‹•ç•«
  showSlashEffect(targetIndex); // âœ… æ–¬æ“Š
  const sprite = document.getElementById(`monsterSprite${targetIndex}`);
  const modal = document.getElementById("battleModal");

  if (sprite) sprite.classList.add("hit-effect");
  if (modal) modal.classList.add("shake");

  setTimeout(() => {
    if (sprite) sprite.classList.remove("hit-effect");
    if (modal) modal.classList.remove("shake");
  }, 300);
}
function applyMagicDamage(skill, targetIndex) {
  const target = monsters[targetIndex];
  const attackerAttr = player.attr;
  const defenderAttr = target.attr;

  let attackerFactor =
    (1 + 0.1 * attackerAttr.ç«) *
    (1 + 0.1 * attackerAttr.æ°´) *
    (1 + 0.1 * attackerAttr.é¢¨) *
    (1 + 0.1 * attackerAttr.é›·);

  let skillFactor =
    (1 + 0.1 * (skill.attr.ç« || 0)) *
    (1 + 0.1 * (skill.attr.æ°´ || 0)) *
    (1 + 0.1 * (skill.attr.é¢¨ || 0)) *
    (1 + 0.1 * (skill.attr.é›· || 0));

  const defenderFactor =
    (1 + 0.1 * defenderAttr.ç«) *
    (1 + 0.1 * defenderAttr.æ°´) *
    (1 + 0.1 * defenderAttr.é¢¨) *
    (1 + 0.1 * defenderAttr.é›·);

  let rawDmg = ((player.atk * attackerFactor) + (skill.basePower * skillFactor));
  rawDmg *= skill.multiplier;
  rawDmg /= (1 + (target.def * defenderFactor / 3));
  rawDmg *= (0.8 + Math.random() * 0.4);

  const dmg = Math.round(rawDmg);
  target.hp = Math.max(0, target.hp - dmg);

  logMessage(`ğŸŒ€ ${player.name} å° ${target.name} æ–½å±• ${skill.name}ï¼Œé€ æˆ ${dmg} å‚·å®³ï¼`, "player");

  // æ›´æ–°è¡€é‡ UI
  document.getElementById(`monsterHP${targetIndex}`).innerText = target.hp;
  document.getElementById(`monsterHpBar${targetIndex}`).style.width = `${(target.hp / target.maxHp) * 100}%`;

  // ğŸŒ€ æ’­æ”¾ç‰¹æ•ˆå‹•ç•«
  showSlashEffect(targetIndex); // âœ… æ–¬æ“Š
  const sprite = document.getElementById(`monsterSprite${targetIndex}`);
  const modal = document.getElementById("battleModal");

  if (sprite) sprite.classList.add("hit-effect");
  if (modal) modal.classList.add("shake");

  setTimeout(() => {
    if (sprite) sprite.classList.remove("hit-effect");
    if (modal) modal.classList.remove("shake");
  }, 300);
}




function startBattle() {
  const username = "admin";
  battleEnded = false; // â¬…ï¸ é€™ä¸€è¡Œæ˜¯æ–°çš„
  document.getElementById("playerHpBar").style.width = "100%";

monsters = [
  { name: "è‰æ€ª1", atk: 80, def: 40, hp: 50, maxHp: 50, spd: 25, attr: { ç«: 1, æ°´: 0, é¢¨: 1, é›·: 0 } },
  { name: "è‰æ€ª2", atk: 100, def: 60, hp: 80, maxHp: 80, spd: 50, attr: { ç«: 0, æ°´: 1, é¢¨: 0, é›·: 1 } },
  { name: "å²èŠå§†", atk: 50, def: 30, hp: 60, maxHp: 60, spd: 70, attr: { ç«: 0, æ°´: 0, é¢¨: 1, é›·: 1 } }
];

  fetch(`${apiBase}?mode=equippedStats&username=${username}`)
    .then(res => res.json())
    .then(stat => {
	renderMonsterSprites();   // æ¸²æŸ“æ€ªç‰©åœ–ç¤ºèˆ‡è¡€æ¢
createMonsterDots();      // æ¸²æŸ“æ¯éš»æ€ªç‰©çš„è¡Œå‹•é»

      player = {
        name: "ç©å®¶",
        atk: parseInt(stat["æ”»æ“ŠåŠ›"]) || 0,
        def: parseInt(stat["é˜²ç¦¦åŠ›"]) || 0,
        hp: parseInt(stat["HP"]) || 0,
        maxHp: parseInt(stat["HP"]) || 0,
		mp: parseInt(stat["MP"]) || 0,  // ğŸ”¥ æ–°å¢é€™è¡Œ
        spd: parseInt(stat["é€Ÿåº¦"]) || 0,
        attr: {
          ç«: parseInt(stat["å±¬æ€§ç«"]) || 0,
          æ°´: parseInt(stat["å±¬æ€§æ°´"]) || 0,
          é¢¨: parseInt(stat["å±¬æ€§é¢¨"]) || 0,
          é›·: parseInt(stat["å±¬æ€§é›·"]) || 0,
        }
      };

      // é¡¯ç¤ºç©å®¶è³‡æ–™
      document.getElementById("playerHP").innerText = player.hp;
      document.getElementById("playerMaxHP").innerText = player.maxHp;
document.getElementById("playerMP").innerText = player.mp;

      // é¡¯ç¤ºæ€ªç‰©è¡€æ¢
      monsters.forEach((m, i) => {
        const hpText = document.getElementById(`monsterHP${i}`);
        const hpBar = document.getElementById(`monsterHpBar${i}`);
        if (hpText) hpText.innerText = m.hp;
        if (hpBar) hpBar.style.width = `${(m.hp / m.maxHp) * 100}%`;

        // é‡è¨­æ€ªç‰©è¡Œå‹•æ¢ä½ç½®
        const dot = document.getElementById(`monsterDot${i}`);
        if (dot) dot.style.left = "0%";
      });

      // é¡¯ç¤ºæˆ°é¬¥ç•«é¢
      document.getElementById("battleModal").style.display = "block";
renderMonsterSprites(); // âœ… æ¸²æŸ“æ€ªç‰©åœ–ç¤º

      // é¡¯ç¤ºé–‹å ´è¨Šæ¯
      document.getElementById("battleLog").innerHTML = "";
      const monsterNames = monsters.map(m => m.name).join(" å’Œ ");
      logMessage(`âš”ï¸ ${player.name} é­é‡ ${monsterNames}ï¼`, "system");

      // åˆå§‹åŒ–æ™‚é–“æ¢é€²åº¦èˆ‡ç‹€æ…‹
      playerDotProgress = 0;
      monsterDotProgress = monsters.map(() => 0); // æ¯éš»æ€ªä¸€å€‹é€²åº¦æ¢
      isPlayerReady = false;
      timelinePaused = false;

      updateTimeline();

      if (timelineLoop) clearInterval(timelineLoop);
      timelineLoop = setInterval(updateTimeline, 100);
    })
    .catch(err => {
      console.error("è®€å–ç©å®¶èƒ½åŠ›å¤±æ•—ï¼š", err);
      alert("ç„¡æ³•è®€å–ç©å®¶èƒ½åŠ›å€¼ï¼Œè«‹ç¨å¾Œå†è©¦ï¼");
    });
}







function updateHpBars() {
  monsters.forEach((m, i) => {
    const bar = document.getElementById(`monsterHpBar${i}`);
    if (bar) {
      bar.style.width = (m.hp / m.maxHp * 100) + "%";
    }
  });

  document.getElementById("playerHpBar").style.width = (player.hp / player.maxHp * 100) + "%";
}





function endBattle() {
  document.getElementById("battleModal").style.display = "none";

  if (timelineLoop) clearInterval(timelineLoop);
  timelineLoop = null;

  playerDotProgress = 0;
  monsterDotProgress = 0;
  isPlayerReady = false;
  timelinePaused = false;

  player = {};
  monster = {};

  const playerDot = document.getElementById("playerDot");
  const monsterDot = document.getElementById("monsterDot");
  if (playerDot) playerDot.style.left = `0%`;
  if (monsterDot) monsterDot.style.left = `0%`;

  const log = document.getElementById("battleLog");
  if (log) log.innerHTML = "";
}



function showAttackTargets() {
  const container = document.getElementById("monsterTargetOptions");
  container.innerHTML = ""; // æ¸…ç©º

  monsters.forEach((m, i) => {
    if (m.hp > 0) {
      const btn = document.createElement("button");
      btn.className = "battle-btn battle-target-btn";

      btn.innerText = `æ”»æ“Š ${m.name}`;
      btn.onclick = () => {
        playerAttack(i);         // åŸ·è¡Œæ”»æ“Š
        container.innerHTML = ""; // é—œé–‰æ”»æ“Šç›®æ¨™è¦–çª—
      };
      container.appendChild(btn);
    }
  });

  logMessage("ğŸ‘‰ é¸æ“‡æ”»æ“Šç›®æ¨™", "system");
}

function showMagicTargets(skillIndex) {
  const container = document.getElementById("monsterTargetOptions");
  container.innerHTML = "";

  monsters.forEach((m, i) => {
    if (m.hp > 0) {
      const btn = document.createElement("button");
      btn.className = "battle-btn battle-target-btn";
      btn.innerText = `å° ${m.name} æ–½å±• ${magicSkills[skillIndex].name}`;
      btn.onclick = () => castMagic(skillIndex, i);
      container.appendChild(btn);
    }
  });

  logMessage("ğŸ‘‰ é¸æ“‡æ–½æ³•ç›®æ¨™", "system");
}







function updateTimeline() {
  if (timelinePaused) return;

  // ç©å®¶æ™‚é–“æ¢æ¨é€²
  if (!isPlayerReady) playerDotProgress += player.spd * 0.05;
  const playerDot = document.getElementById("playerDot");
  if (playerDot) playerDot.style.left = `${Math.min(playerDotProgress, TIMELINE_MAX)}%`;

  // ç©å®¶å¯è¡Œå‹•
  if (playerDotProgress >= TIMELINE_MAX && !isPlayerReady) {
    isPlayerReady = true;
    playerDotProgress = TIMELINE_MAX;
    timelinePaused = true;
    showBattleActions();
  }

  // æ€ªç‰©æ™‚é–“æ¢æ¨é€²
  monsters.forEach((m, i) => {
    if (m.hp <= 0) {
      const dot = document.getElementById(`monsterDot${i}`);
      if (dot) dot.style.display = "none";
      return;
    }

    monsterDotProgress[i] += m.spd * 0.05;
    const dot = document.getElementById(`monsterDot${i}`);
    if (dot) {
      dot.style.display = "block";
      dot.style.left = `${Math.min(monsterDotProgress[i], TIMELINE_MAX)}%`;
    }

    if (monsterDotProgress[i] >= TIMELINE_MAX) {
      monsterDotProgress[i] = 0;
      monsterAttack(i);
    }
  });

  // âœ… æœ€å¾Œæ‰æª¢æŸ¥æˆ°é¬¥æ˜¯å¦çµæŸ
  if (!battleEnded) {
  if (player.hp <= 0) {
    battleEnded = true;
    endFight("ä½ è¢«æ‰“å€’äº†â€¦ğŸ’€");
  } else if (monsters.every(m => m.hp <= 0)) {
    battleEnded = true;
    endFight("ä½ æ“Šæ•—äº†æ‰€æœ‰æ•µäººï¼ğŸ‰");
  }
}

}





  const playerDot = document.getElementById("playerDot");
  

  if (playerDot) playerDot.style.left = `${Math.min(playerDotProgress, TIMELINE_MAX)}%`;


  if (playerDotProgress >= TIMELINE_MAX && !isPlayerReady) {
    isPlayerReady = true;
    playerDotProgress = TIMELINE_MAX;
    timelinePaused = true; // âœ… æš«åœæ•´é«”æ™‚é–“æ¢
    showBattleActions();
  }

  if (monsterDotProgress >= TIMELINE_MAX) {
    monsterDotProgress = 0;
    monsterAttack();
  }


function showBattleActions() {
  document.getElementById("battleActions").style.display = "flex";
  document.getElementById("magicBtn").disabled = false; // âœ… å•Ÿç”¨æ³•è¡“æ”»æ“ŠæŒ‰éˆ•
  logMessage("ğŸ”” è«‹é¸æ“‡ä½ çš„è¡Œå‹•ï¼", "system");

  const container = document.getElementById("monsterTargetOptions");
  container.innerHTML = ""; // ä¸è¦å…ˆé¡¯ç¤ºæ”»æ“Šç›®æ¨™æŒ‰éˆ•
}




function hideBattleActions() {
  document.getElementById("battleActions").style.display = "none";
}

// âœ… æ”¹å¯« playerAttack åŸ·è¡Œå¾ŒçºŒæµç¨‹ï¼Œä¸¦é‡æ–°å•Ÿå‹•æ™‚é–“æ¢
function playerAttack(targetIndex) {
  const target = monsters[targetIndex];
  const dmg = calculateDamage(player, target);
  target.hp = Math.max(0, target.hp - dmg);

  logMessage(`${player.name} å° ${target.name} é€ æˆ ${dmg} å‚·å®³ï¼`, "player");

  document.getElementById(`monsterHP${targetIndex}`).innerText = target.hp;
  document.getElementById(`monsterHpBar${targetIndex}`).style.width = `${(target.hp / target.maxHp) * 100}%`;

  // æ”»æ“Šå‹•ç•«
  const sprite = document.getElementById(`monsterSprite${targetIndex}`);
  const modal = document.getElementById("battleModal");
  if (sprite) sprite.classList.add("hit-effect");
  if (modal) modal.classList.add("shake");

  setTimeout(() => {
    if (sprite) sprite.classList.remove("hit-effect");
    if (modal) modal.classList.remove("shake");
  }, 300);

  // æª¢æŸ¥æ€ªç‰©æ­»äº¡
  if (target.hp <= 0) {
    logMessage(`ğŸ‰ ${target.name} è¢«æ“Šæ•—ï¼`, "system");
  }

  playerDotProgress = 0;
  isPlayerReady = false;
  timelinePaused = false;
  hideBattleActions();
}



function playerMagicAttack(targetIndex) {
  const MP_COST = 20;
  if (player.mp < MP_COST) {
    logMessage("âš ï¸ MP ä¸è¶³ï¼Œç„¡æ³•æ–½æ”¾æ³•è¡“", "system");
    return;
  }

  player.mp -= MP_COST;
  document.getElementById("playerMP").innerText = player.mp;

  const target = monsters[targetIndex];
  const baseDmg = calculateDamage(player, target);
  const dmg = Math.round(baseDmg * 1.5); // æ³•è¡“å‚·å®³åŠ æˆ

  target.hp = Math.max(0, target.hp - dmg);

  logMessage(`âœ¨ ${player.name} å° ${target.name} æ–½æ”¾æ³•è¡“é€ æˆ ${dmg} å‚·å®³ï¼`, "player");

  document.getElementById(`monsterHP${targetIndex}`).innerText = target.hp;
  document.getElementById(`monsterHpBar${targetIndex}`).style.width = `${(target.hp / target.maxHp) * 100}%`;

  const sprite = document.getElementById(`monsterSprite${targetIndex}`);
  const modal = document.getElementById("battleModal");
  if (sprite) sprite.classList.add("hit-effect");
  if (modal) modal.classList.add("shake");

  setTimeout(() => {
    if (sprite) sprite.classList.remove("hit-effect");
    if (modal) modal.classList.remove("shake");
  }, 300);

  if (target.hp <= 0) {
    logMessage(`ğŸ‰ ${target.name} è¢«æ³•è¡“æ“Šæ•—ï¼`, "system");
  }

  playerDotProgress = 0;
  isPlayerReady = false;
  timelinePaused = false;
  hideBattleActions();
}



function monsterAttack(index) {
  const attacker = monsters[index];
  if (!attacker || attacker.hp <= 0) return;

  const dmg = calculateDamage(attacker, player);
  player.hp = Math.max(0, player.hp - dmg);

  logMessage(`${attacker.name} æ”»æ“Šä½ é€ æˆ ${dmg} å‚·å®³ï¼`, "monster");

  document.getElementById("playerHP").innerText = player.hp;
  updateHpBars();

  // âœ… åŠ ä¸Šå—æ“Šå‹•ç•«èˆ‡ç•«é¢éœ‡å‹•
  const sprite = document.getElementById("playerSprite");
  const modal = document.getElementById("battleModal");

  if (sprite) sprite.classList.add("hit-effect");
  modal.classList.add("shake");

  setTimeout(() => {
    if (sprite) sprite.classList.remove("hit-effect");
    modal.classList.remove("shake");
  }, 300);

  if (player.hp <= 0) endFight("ä½ è¢«æ‰“å€’äº†â€¦ğŸ’€");
}



function endFight(msg) {
  logMessage(`<strong>${msg}</strong>`, "system");

  // é—œé–‰æŒ‰éˆ•
  document.getElementById("battleActions").style.display = "none";
  document.getElementById("monsterTargetOptions").innerHTML = "";

  // ç­‰å¾… 1.5 ç§’å¾Œè‡ªå‹•é—œé–‰æˆ°é¬¥è¦–çª—
  setTimeout(() => {
    endBattle();
  }, 1500);
}



function logMessage(message, type = "system") {
  const log = document.getElementById("battleLog");
  const div = document.createElement("div");

  if (type === "player") {
    div.style.textAlign = "right";
    div.style.color = "#0033aa";
  } else if (type === "monster") {
    div.style.textAlign = "left";
    div.style.color = "#aa0000";
  } else {
    div.style.textAlign = "center";
    div.style.color = "#4444cc";
    message = `<strong>${message}</strong>`;  // âœ… åªæœ‰ system æ‰åŠ ç²—
  }

  div.innerHTML = message;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}



function calculateDamage(attacker, defender) {
  const attackerAttr = attacker.attr;
  const defenderAttr = defender.attr;

  // å±¬æ€§åŠ æˆï¼ˆå¯è¤‡é›œåŒ–ï¼‰
  const attackerFactor =
    (1 + 0.1 * (attackerAttr.ç« || 0)) *
    (1 + 0.1 * (attackerAttr.æ°´ || 0)) *
    (1 + 0.1 * (attackerAttr.é¢¨ || 0)) *
    (1 + 0.1 * (attackerAttr.é›· || 0));

  const defenderFactor =
    (1 + 0.1 * (defenderAttr.ç« || 0)) *
    (1 + 0.1 * (defenderAttr.æ°´ || 0)) *
    (1 + 0.1 * (defenderAttr.é¢¨ || 0)) *
    (1 + 0.1 * (defenderAttr.é›· || 0));

  let raw = (attacker.atk * attackerFactor) / (1 + (defender.def * defenderFactor / 3));
  raw *= (0.8 + Math.random() * 0.4); // æµ®å‹•ä¿‚æ•¸ 0.8~1.2
  return Math.round(raw);
}



function showSlashEffect(targetIndex) {
  const target = document.getElementById(`monsterSprite${targetIndex}`);
  if (!target) return;

  const rect = target.getBoundingClientRect();

  const effect = document.createElement("div");
  effect.className = "slash-effect";

  // ğŸ§© è¨ˆç®—æ–¬æ“Šå‹•ç•«å‡ºç¾çš„ä½ç½®ï¼ˆç•«é¢ä¸Šæ€ªç‰©ä¸­é–“ï¼‰
  effect.style.position = "fixed";  // ç”¨ fixed æ‰ä¸æœƒè¢«çˆ¶å±¤å½±éŸ¿
  effect.style.left = `${rect.left + rect.width / 2 - 150}px`; // 150 æ˜¯å‹•ç•«å¯¬åº¦çš„ä¸€åŠ
  effect.style.top = `${rect.top + rect.height * 0.3}px`; // æ€ªç‰©é ­ä¸Šåä¸‹ä¸€é»

  document.body.appendChild(effect);

  setTimeout(() => {
    effect.remove();
  }, 500);
}




</script>
  <script>
function renderMonsterSprites() {
  const container = document.getElementById("monsterSprites");
  container.innerHTML = ""; // æ¸…ç©ºåŸæœ¬å…§å®¹

  monsters.forEach((m, i) => {
    const sprite = document.createElement("div");
    sprite.id = `monsterSprite${i}`;
    sprite.style.position = "absolute";
    sprite.style.left = `${i * 130}px`; // æ¯éš»æ€ªé–“è·
    sprite.innerHTML = `
      <div style="font-size: 40px;">ğŸŒ¿</div>
      <div style="font-weight: bold;">${m.name}</div>
      <div style="width: 100px; background: #ccc; border-radius: 6px;">
        <div id="monsterHpBar${i}" style="height: 10px; background: #66cc66; width: 100%; border-radius: 6px;"></div>
      </div>
      <div style="font-size: 12px;">HPï¼š<span id="monsterHP${i}">${m.hp}</span></div>
    `;
    container.appendChild(sprite);
  });
}
// â¬‡ï¸ æ–°å¢é€™æ®µï¼šç”Ÿæˆæ€ªç‰©è¡Œå‹•é» UIï¼ˆmonsterDotï¼‰
function createMonsterDots() {
  const timeline = document.getElementById("atbTimeline");
  // ç§»é™¤èˆŠæœ‰ monsterDot
  [...timeline.querySelectorAll(".monster-dot")].forEach(dot => dot.remove());

  monsters.forEach((_, i) => {
    const dot = document.createElement("div");
    dot.className = "monster-dot";
    dot.id = `monsterDot${i}`;
    dot.style.width = "16px";
    dot.style.height = "16px";
    dot.style.borderRadius = "50%";
    dot.style.background = i % 2 === 0 ? "#66cc66" : "#aaffaa";
    dot.style.position = "absolute";
    dot.style.top = "7px";
    dot.style.left = "0px";
    timeline.appendChild(dot);
  });
}

// â¬‡ï¸ å‘¼å«ä½ç½®ï¼šåœ¨ startBattle çš„ monsters è¨­å®šå®Œæˆå¾ŒåŠ å…¥ï¼šcreateMonsterDots();
</script>
  
</body>
</html>
